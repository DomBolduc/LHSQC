
<?php
// Inclusion du CSS moderne
echo '<link rel="stylesheet" href="css/components/transactions.css">';

// Nom du fichier de la base de donnÃ©es SQLite
$databaseFile = 'LHSQC-STHS.db';
// Connexion Ã  la base de donnÃ©es SQLite
$db = new SQLite3($databaseFile);
// RequÃªte pour rÃ©cupÃ©rer les 20 derniÃ¨res entrÃ©es (= 10 transactions complÃ¨tes)
$query = "SELECT
    ReceivingTeamThemeID, ReceivingTeamName, ReceivingTeamText,
    SendingTeamThemeID, SendingTeamName, SendingTeamText,
    DateTxt, Number
FROM TradeLog
ORDER BY Number DESC
LIMIT 20";

$result = $db->query($query);

// VÃ©rifier si la requÃªte a rÃ©ussi
if ($result === false) {
    echo "<!-- Erreur SQL: " . $db->lastErrorMsg() . " -->";
    // RequÃªte de fallback plus simple
    $query = "SELECT ReceivingTeamThemeID, ReceivingTeamName, ReceivingTeamText, Number FROM TradeLog ORDER BY Number DESC LIMIT 15";
    $result = $db->query($query);
}

// Fonction pour dÃ©terminer le type de transaction
function getTransactionType($text) {
    $text = strtolower($text);
    if (strpos($text, 'trade') !== false || strpos($text, 'Ã©change') !== false) {
        return 'trade';
    } elseif (strpos($text, 'waiver') !== false || strpos($text, 'ballotage') !== false) {
        return 'waiver';
    } elseif (strpos($text, 'injury') !== false || strpos($text, 'blessure') !== false) {
        return 'injury';
    } elseif (strpos($text, 'suspension') !== false) {
        return 'suspension';
    }
    return 'trade'; // Par dÃ©faut
}

// Fonction pour obtenir le label du type
function getTransactionTypeLabel($type) {
    switch($type) {
        case 'trade': return 'Trade';
        case 'waiver': return 'Waiver';
        case 'injury': return 'Injury';
        case 'suspension': return 'Suspension';
        default: return 'Trade';
    }
}

?>


<div class="transactions-card">
    <div class="transactions-header">Latest Transactions</div>
    <div class="transactions-content">
        <?php
        $hasTransactions = false;
        $processedTrades = array(); // Pour Ã©viter les doublons
        echo '<ul class="transactions-list">';

        // Collecter toutes les transactions
        $allTransactions = array();
        if ($result !== false) {
            while ($row = $result->fetchArray(SQLITE3_ASSOC)) {
                $allTransactions[] = $row;
            }
        }

        // CrÃ©er un index des transactions par numÃ©ro
        $transactionsByNumber = array();
        foreach ($allTransactions as $transaction) {
            $num = isset($transaction['Number']) ? $transaction['Number'] : 0;
            $transactionsByNumber[$num] = $transaction;
        }

        // Trouver le numÃ©ro le plus Ã©levÃ© et regrouper par paires
        $maxNumber = max(array_keys($transactionsByNumber));
        $groupedTrades = array();

        // Commencer par le numÃ©ro le plus Ã©levÃ© et descendre par paires
        for ($num = $maxNumber; $num >= 1; $num -= 2) {
            // Pour chaque paire, vÃ©rifier si les deux numÃ©ros existent
            $pairNum = $num % 2 == 0 ? $num - 1 : $num + 1; // Trouver le numÃ©ro de la paire

            if (isset($transactionsByNumber[$num]) && isset($transactionsByNumber[$pairNum])) {
                // Paire complÃ¨te trouvÃ©e
                $trade = array(
                    'type' => 'complete',
                    'transaction1' => $transactionsByNumber[max($num, $pairNum)], // Le plus grand numÃ©ro
                    'transaction2' => $transactionsByNumber[min($num, $pairNum)]  // Le plus petit numÃ©ro
                );
                $groupedTrades[] = $trade;

                // Retirer ces transactions de la liste pour Ã©viter les doublons
                unset($transactionsByNumber[$num]);
                unset($transactionsByNumber[$pairNum]);
            }
        }

        // Ajouter les transactions orphelines restantes
        foreach ($transactionsByNumber as $num => $transaction) {
            $trade = array(
                'type' => 'single',
                'transaction1' => $transaction
            );
            $groupedTrades[] = $trade;
        }

        // Limiter Ã  10 trades maximum
        $groupedTrades = array_slice($groupedTrades, 0, 10);

        // Afficher les trades regroupÃ©s
        foreach ($groupedTrades as $trade) {
            $hasTransactions = true;
            $currentTransaction = $trade['transaction1'];
            $nextTransaction = isset($trade['transaction2']) ? $trade['transaction2'] : null;

                $transactionText = isset($currentTransaction['ReceivingTeamText']) ? $currentTransaction['ReceivingTeamText'] : '';
                $transactionType = getTransactionType($transactionText);
                $typeLabel = getTransactionTypeLabel($transactionType);
                ?>

                <li class="transaction-item">
                    <?php if ($nextTransaction): ?>
                        <!-- Trade complet avec deux Ã©quipes -->
                        <div class="trade-teams">
                            <div class="team-side">
                                <div class="team-logo-container">
                                    <img src="images/<?= isset($currentTransaction['ReceivingTeamThemeID']) ? $currentTransaction['ReceivingTeamThemeID'] : '0' ?>.png"
                                         alt="<?= htmlspecialchars(isset($currentTransaction['ReceivingTeamName']) ? $currentTransaction['ReceivingTeamName'] : 'Team') ?> Logo"
                                         class="team-logo">
                                </div>
                                <div class="team-name"><?= htmlspecialchars(isset($currentTransaction['ReceivingTeamName']) ? $currentTransaction['ReceivingTeamName'] : 'Team') ?></div>
                            </div>

                            <div class="trade-arrow">â‡„</div>

                            <div class="team-side">
                                <div class="team-logo-container">
                                    <img src="images/<?= isset($nextTransaction['ReceivingTeamThemeID']) ? $nextTransaction['ReceivingTeamThemeID'] : '0' ?>.png"
                                         alt="<?= htmlspecialchars(isset($nextTransaction['ReceivingTeamName']) ? $nextTransaction['ReceivingTeamName'] : 'Team') ?> Logo"
                                         class="team-logo">
                                </div>
                                <div class="team-name"><?= htmlspecialchars(isset($nextTransaction['ReceivingTeamName']) ? $nextTransaction['ReceivingTeamName'] : 'Team') ?></div>
                            </div>
                        </div>

                        <div class="transaction-info">
                            <div class="transaction-details">
                                <div class="trade-detail"><?= htmlspecialchars(isset($currentTransaction['ReceivingTeamText']) ? $currentTransaction['ReceivingTeamText'] : '') ?></div>
                                <div class="trade-detail"><?= htmlspecialchars(isset($nextTransaction['ReceivingTeamText']) ? $nextTransaction['ReceivingTeamText'] : '') ?></div>
                            </div>
                        </div>

                    <?php else: ?>
                        <!-- Transaction simple -->
                        <div class="team-logo-container">
                            <img src="images/<?= isset($currentTransaction['ReceivingTeamThemeID']) ? $currentTransaction['ReceivingTeamThemeID'] : '0' ?>.png"
                                 alt="<?= htmlspecialchars(isset($currentTransaction['ReceivingTeamName']) ? $currentTransaction['ReceivingTeamName'] : 'Team') ?> Logo"
                                 class="team-logo">
                        </div>

                        <div class="transaction-info">
                            <div class="team-name"><?= htmlspecialchars(isset($currentTransaction['ReceivingTeamName']) ? $currentTransaction['ReceivingTeamName'] : 'Team') ?></div>
                            <div class="transaction-details"><?= htmlspecialchars(isset($currentTransaction['ReceivingTeamText']) ? $currentTransaction['ReceivingTeamText'] : '') ?></div>
                        </div>
                    <?php endif; ?>

                    <div class="transaction-type">
                        <span class="type-badge type-<?= $transactionType ?>"><?= $typeLabel ?></span>
                    </div>
                </li>

                <?php
        }

        // Si aucune transaction trouvÃ©e
        if (!$hasTransactions) {
            echo '<li class="no-transactions">';
            echo '<div class="no-transactions-icon">ðŸ“‹</div>';
            echo '<div class="no-transactions-text">Aucune transaction rÃ©cente</div>';
            echo '</li>';
        }

        echo '</ul>';
        ?>
    </div>
</div>

<?php
    // Fermer la connexion Ã  la base de donnÃ©es
    $db->close();
?>